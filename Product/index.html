<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pump Sales Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .month-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .month-btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            background: white;
            color: #667eea;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .month-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .month-btn.active {
            background: #764ba2;
            color: white;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.5em;
            padding: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #999;
            font-size: 0.85em;
        }

        .product-stats {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .product-stats h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .product-item {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .product-item h4 {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .product-item .metric {
            margin-bottom: 10px;
        }

        .product-item .metric-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .product-item .metric-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .chart-container h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>â›½ Pump Sales Dashboard</h1>
            <p>Real-time sales analytics for UX, DX & V-Power</p>
        </div>

        <div class="month-selector">
            <button class="month-btn active" data-month="september">September 2025</button>
            <button class="month-btn" data-month="august">August 2025</button>
        </div>

        <div id="loading" class="loading">Loading data...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Sales</h3>
                    <div class="value" id="totalSales">0</div>
                    <div class="label">All Products</div>
                </div>
                <div class="stat-card">
                    <h3>Average Daily Sales</h3>
                    <div class="value" id="avgDailySales">0</div>
                    <div class="label">Per Day</div>
                </div>
                <div class="stat-card">
                    <h3>Best Selling Product</h3>
                    <div class="value" id="topProduct">-</div>
                    <div class="label">By Revenue</div>
                </div>
                <div class="stat-card">
                    <h3>Days of Data</h3>
                    <div class="value" id="daysCount">0</div>
                    <div class="label">Trading Days</div>
                </div>
            </div>

            <div class="product-stats">
                <h2>ðŸ“Š Product Performance</h2>
                <div class="product-grid" id="productGrid"></div>
            </div>

            <div class="chart-container">
                <h2>ðŸ“ˆ Daily Sales Trend</h2>
                <div class="chart-wrapper">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>ðŸ¥§ Revenue Distribution by Product</h2>
                <div class="chart-wrapper">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DATA_URLS = {
            september: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-k0UvgWAF628NHqYnQ58rXfOpyMnrqnRa19R-icgOlkeK2yEhP3hg2_9CtwYCHZ08ciLYioLZNTc7/pub?gid=1763262818&single=true&output=csv',
            august: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSy-gNhdVGwWtpwJIZ2358iDhM0RQlQoen-_wayM6Dc0rkp9mRx40uLo4ia2QD3Kr_QNn75xp8OJKEx/pub?gid=1227672918&single=true&output=csv'
        };

        let currentMonth = 'september';
        let salesData = [];
        let charts = {};

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES',
                minimumFractionDigits: 2
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('en-KE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function loadData(month) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            Papa.parse(DATA_URLS[month], {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    try {
                        salesData = results.data.filter(row => row.DATES && row.TOTAL);
                        if (salesData.length === 0) {
                            throw new Error('No valid data found');
                        }
                        processData();
                        renderDashboard();
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('dashboard').style.display = 'block';
                    } catch (err) {
                        showError('Error processing data: ' + err.message);
                    }
                },
                error: function(err) {
                    showError('Error loading data: ' + err.message);
                }
            });
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function processData() {
            salesData.forEach(row => {
                row.UX = parseFloat(row.UX) || 0;
                row.DX = parseFloat(row.DX) || 0;
                row['V-POWER'] = parseFloat(row['V-POWER']) || 0;
                row.TOTAL = parseFloat(row.TOTAL) || 0;
            });
        }

        function renderDashboard() {
            const totalSales = salesData.reduce((sum, row) => sum + row.TOTAL, 0);
            const uxTotal = salesData.reduce((sum, row) => sum + row.UX, 0);
            const dxTotal = salesData.reduce((sum, row) => sum + row.DX, 0);
            const vPowerTotal = salesData.reduce((sum, row) => sum + row['V-POWER'], 0);
            const avgDaily = totalSales / salesData.length;

            const products = [
                { name: 'UX (Unleaded)', total: uxTotal, color: '#667eea' },
                { name: 'DX (Diesel)', total: dxTotal, color: '#764ba2' },
                { name: 'V-Power', total: vPowerTotal, color: '#f093fb' }
            ];

            const topProduct = products.reduce((max, p) => p.total > max.total ? p : max);

            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('avgDailySales').textContent = formatCurrency(avgDaily);
            document.getElementById('topProduct').textContent = topProduct.name.split(' ')[0];
            document.getElementById('daysCount').textContent = salesData.length;

            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = products.map(p => `
                <div class="product-item">
                    <h4>${p.name}</h4>
                    <div class="metric">
                        <div class="metric-label">Total Sales</div>
                        <div class="metric-value">${formatCurrency(p.total)}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Average Daily</div>
                        <div class="metric-value">${formatCurrency(p.total / salesData.length)}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Share</div>
                        <div class="metric-value">${((p.total / totalSales) * 100).toFixed(1)}%</div>
                    </div>
                </div>
            `).join('');

            renderCharts(products);
        }

        function renderCharts(products) {
            if (charts.line) charts.line.destroy();
            if (charts.pie) charts.pie.destroy();

            const ctx1 = document.getElementById('salesChart').getContext('2d');
            charts.line = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: salesData.map(row => row.DATES),
                    datasets: [
                        {
                            label: 'UX (Unleaded)',
                            data: salesData.map(row => row.UX),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'DX (Diesel)',
                            data: salesData.map(row => row.DX),
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'V-Power',
                            data: salesData.map(row => row['V-POWER']),
                            borderColor: '#f093fb',
                            backgroundColor: 'rgba(240, 147, 251, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'KES ' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });

            const ctx2 = document.getElementById('pieChart').getContext('2d');
            charts.pie = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: products.map(p => p.name),
                    datasets: [{
                        data: products.map(p => p.total),
                        backgroundColor: products.map(p => p.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        document.querySelectorAll('.month-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentMonth = this.dataset.month;
                loadData(currentMonth);
            });
        });

        loadData(currentMonth);
    </script>
</body>
</html>
