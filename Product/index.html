<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pump Sales Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .month-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .month-btn {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            background: #f0f0f0;
            color: #667eea;
            font-weight: bold;
            transition: all 0.3s;
        }

        .month-btn:hover {
            transform: translateY(-2px);
            background: #e0e0e0;
        }

        .month-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .price-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .price-input-group {
            display: flex;
            flex-direction: column;
        }

        .price-input-group label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .price-input-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .price-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.5em;
            padding: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #999;
            font-size: 0.85em;
        }

        .product-stats {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .product-stats h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .product-item {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .product-item h4 {
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .product-item .metric {
            margin-bottom: 10px;
        }

        .product-item .metric-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .product-item .metric-value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .chart-container h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .toggle-view {
            text-align: center;
            margin-bottom: 10px;
        }

        .toggle-btn {
            padding: 8px 20px;
            margin: 0 5px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            background: #f0f0f0;
            color: #667eea;
            font-weight: 600;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Pump Sales Dashboard</h1>
            <p>Sales analytics for UX (Unleaded), DX (Diesel) & V-Power</p>
        </div>

        <div class="controls">
            <div class="month-selector">
                <button class="month-btn active" data-month="september">September 2024</button>
                <button class="month-btn" data-month="august">August 2024</button>
            </div>
            <div class="price-inputs">
                <div class="price-input-group">
                    <label for="uxPrice">UX Price (KES/Litre)</label>
                    <input type="number" id="uxPrice" value="180.00" step="0.01" min="0">
                </div>
                <div class="price-input-group">
                    <label for="dxPrice">DX Price (KES/Litre)</label>
                    <input type="number" id="dxPrice" value="165.00" step="0.01" min="0">
                </div>
                <div class="price-input-group">
                    <label for="vPowerPrice">V-Power Price (KES/Litre)</label>
                    <input type="number" id="vPowerPrice" value="195.00" step="0.01" min="0">
                </div>
            </div>
        </div>

        <div id="loading" class="loading">Loading data...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="dashboard" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Volume</h3>
                    <div class="value" id="totalLitres">0</div>
                    <div class="label">Litres Sold</div>
                </div>
                <div class="stat-card">
                    <h3>Total Revenue</h3>
                    <div class="value" id="totalRevenue">0</div>
                    <div class="label">From All Products</div>
                </div>
                <div class="stat-card">
                    <h3>Average Daily Volume</h3>
                    <div class="value" id="avgDailyLitres">0</div>
                    <div class="label">Litres per Day</div>
                </div>
                <div class="stat-card">
                    <h3>Days of Data</h3>
                    <div class="value" id="daysCount">0</div>
                    <div class="label">Trading Days</div>
                </div>
            </div>

            <div class="product-stats">
                <h2>Product Performance</h2>
                <div class="product-grid" id="productGrid"></div>
            </div>

            <div class="chart-container">
                <h2>Daily Sales Trend</h2>
                <div class="toggle-view">
                    <button class="toggle-btn active" data-view="litres">View Litres</button>
                    <button class="toggle-btn" data-view="revenue">View Revenue</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>Distribution by Product</h2>
                <div class="toggle-view">
                    <button class="toggle-btn active" data-view="litres-pie">View Litres</button>
                    <button class="toggle-btn" data-view="revenue-pie">View Revenue</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DATA_URLS = {
            august: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSy-gNhdVGwWtpwJIZ2358iDhM0RQlQoen-_wayM6Dc0rkp9mRx40uLo4ia2QD3Kr_QNn75xp8OJKEx/pub?gid=1227672918&single=true&output=csv',
            september: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS-k0UvgWAF628NHqYnQ58rXfOpyMnrqnRa19R-icgOlkeK2yEhP3hg2_9CtwYCHZ08ciLYioLZNTc7/pub?gid=1763262818&single=true&output=csv'
        };

        let currentMonth = 'september';
        let salesData = [];
        let charts = {};
        let currentView = 'litres';
        let currentPieView = 'litres-pie';

        const prices = {
            ux: 180,
            dx: 165,
            vPower: 195
        };

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES',
                minimumFractionDigits: 2
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('en-KE', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function csvToArray(csv, delimiter = ',') {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(delimiter).map(h => h.trim());
            return lines.slice(1).map(line => {
                const items = line.split(delimiter);
                let obj = {};
                headers.forEach((h, i) => {
                    obj[h] = items[i] ? items[i].trim() : "";
                });
                return obj;
            });
        }

        async function loadData(month) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            try {
                const response = await fetch(DATA_URLS[month]);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                if (!text || text.trim() === '') {
                    throw new Error('Empty response from Google Sheets');
                }
                
                const rows = csvToArray(text);
                salesData = [];
                
                rows.forEach(row => {
                    if (!row.DATES || row.DATES === '' || row.DATES === 'TOTALS') return;
                    
                    const ux = Math.abs(parseFloat(row.UX) || 0);
                    const dx = Math.abs(parseFloat(row.DX) || 0);
                    const vPower = Math.abs(parseFloat(row['V-POWER']) || 0);
                    const total = ux + dx + vPower;
                    
                    if (total > 0) {
                        salesData.push({
                            DATES: row.DATES,
                            UX: ux,
                            DX: dx,
                            'V-POWER': vPower,
                            TOTAL: total
                        });
                    }
                });
                
                if (salesData.length === 0) {
                    throw new Error('No valid data found in the spreadsheet');
                }
                
                renderDashboard();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
            } catch (err) {
                showError('Error loading data: ' + err.message);
            }
        }

        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function updatePrices() {
            prices.ux = parseFloat(document.getElementById('uxPrice').value) || 180;
            prices.dx = parseFloat(document.getElementById('dxPrice').value) || 165;
            prices.vPower = parseFloat(document.getElementById('vPowerPrice').value) || 195;
            if (salesData.length > 0) {
                renderDashboard();
            }
        }

        function renderDashboard() {
            const totalLitres = salesData.reduce((sum, row) => sum + row.TOTAL, 0);
            const uxLitres = salesData.reduce((sum, row) => sum + row.UX, 0);
            const dxLitres = salesData.reduce((sum, row) => sum + row.DX, 0);
            const vPowerLitres = salesData.reduce((sum, row) => sum + row['V-POWER'], 0);
            
            const uxRevenue = uxLitres * prices.ux;
            const dxRevenue = dxLitres * prices.dx;
            const vPowerRevenue = vPowerLitres * prices.vPower;
            const totalRevenue = uxRevenue + dxRevenue + vPowerRevenue;
            
            const avgDailyLitres = totalLitres / salesData.length;

            document.getElementById('totalLitres').textContent = formatNumber(totalLitres) + ' L';
            document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('avgDailyLitres').textContent = formatNumber(avgDailyLitres) + ' L';
            document.getElementById('daysCount').textContent = salesData.length;

            const products = [
                { 
                    name: 'UX (Unleaded)', 
                    litres: uxLitres, 
                    revenue: uxRevenue,
                    price: prices.ux,
                    color: '#667eea' 
                },
                { 
                    name: 'DX (Diesel)', 
                    litres: dxLitres, 
                    revenue: dxRevenue,
                    price: prices.dx,
                    color: '#764ba2' 
                },
                { 
                    name: 'V-Power', 
                    litres: vPowerLitres, 
                    revenue: vPowerRevenue,
                    price: prices.vPower,
                    color: '#f093fb' 
                }
            ];

            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = products.map(p => `
                <div class="product-item">
                    <h4>${p.name}</h4>
                    <div class="metric">
                        <div class="metric-label">Total Volume</div>
                        <div class="metric-value">${formatNumber(p.litres)} L</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Total Revenue</div>
                        <div class="metric-value">${formatCurrency(p.revenue)}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Price per Litre</div>
                        <div class="metric-value">${formatCurrency(p.price)}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Volume Share</div>
                        <div class="metric-value">${((p.litres / totalLitres) * 100).toFixed(1)}%</div>
                    </div>
                </div>
            `).join('');

            renderCharts(products);
        }

        function renderCharts(products) {
            if (charts.line) charts.line.destroy();
            if (charts.pie) charts.pie.destroy();

            const ctx1 = document.getElementById('salesChart').getContext('2d');
            
            const datasets = currentView === 'litres' ? [
                {
                    label: 'UX (Unleaded)',
                    data: salesData.map(row => row.UX),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'DX (Diesel)',
                    data: salesData.map(row => row.DX),
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'V-Power',
                    data: salesData.map(row => row['V-POWER']),
                    borderColor: '#f093fb',
                    backgroundColor: 'rgba(240, 147, 251, 0.1)',
                    tension: 0.4
                }
            ] : [
                {
                    label: 'UX (Unleaded)',
                    data: salesData.map(row => row.UX * prices.ux),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'DX (Diesel)',
                    data: salesData.map(row => row.DX * prices.dx),
                    borderColor: '#764ba2',
                    backgroundColor: 'rgba(118, 75, 162, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'V-Power',
                    data: salesData.map(row => row['V-POWER'] * prices.vPower),
                    borderColor: '#f093fb',
                    backgroundColor: 'rgba(240, 147, 251, 0.1)',
                    tension: 0.4
                }
            ];

            charts.line = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: salesData.map(row => row.DATES),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (currentView === 'litres') {
                                        return `${label}: ${formatNumber(value)} L`;
                                    } else {
                                        return `${label}: ${formatCurrency(value)}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (currentView === 'litres') {
                                        return formatNumber(value) + ' L';
                                    } else {
                                        return 'KES ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                }
            });

            const ctx2 = document.getElementById('pieChart').getContext('2d');
            const pieData = currentPieView === 'litres-pie' 
                ? products.map(p => p.litres)
                : products.map(p => p.revenue);

            charts.pie = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: products.map(p => p.name),
                    datasets: [{
                        data: pieData,
                        backgroundColor: products.map(p => p.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    if (currentPieView === 'litres-pie') {
                                        return `${label}: ${formatNumber(value)} L (${percentage}%)`;
                                    } else {
                                        return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        document.querySelectorAll('.month-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentMonth = this.dataset.month;
                loadData(currentMonth);
            });
        });

        document.querySelectorAll('.toggle-btn[data-view="litres"], .toggle-btn[data-view="revenue"]').forEach(btn => {
            btn.addEventListener('click', function() {
                const parent = this.parentElement;
                parent.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentView = this.dataset.view;
                renderDashboard();
            });
        });

        document.querySelectorAll('.toggle-btn[data-view="litres-pie"], .toggle-btn[data-view="revenue-pie"]').forEach(btn => {
            btn.addEventListener('click', function() {
                const parent = this.parentElement;
                parent.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentPieView = this.dataset.view;
                renderDashboard();
            });
        });

        ['uxPrice', 'dxPrice', 'vPowerPrice'].forEach(id => {
            document.getElementById(id).addEventListener('change', updatePrices);
        });

        loadData(currentMonth);
    </script>
</body>
</html>
