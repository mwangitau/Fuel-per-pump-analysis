<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pump Sales Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/1.30.1/date_fns.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .refresh-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 20px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 1rem;
            font-weight: 500;
        }

        .stat-change {
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .positive {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
        }

        .negative {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .error {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .last-updated {
            text-align: center;
            color: white;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ¢Ô∏è Pump Sales Dashboard</h1>
            <p>Real-time Sales Performance Analytics</p>
            <div class="last-updated" id="lastUpdated"></div>
        </div>

        <button class="refresh-btn" onclick="loadData()">
            üîÑ Refresh Data
        </button>

        <div class="loading" id="loading" style="display: none;">
            Loading data from Google Sheets...
        </div>

        <div class="error" id="error" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <!-- Key Metrics -->
            <div class="stats-grid" id="statsGrid">
                <!-- Stats will be populated here -->
            </div>

            <!-- Chart Navigation -->
            <div class="tabs">
                <button class="tab active" onclick="showChart('performance', this)">üìà Performance Trends</button>
                <button class="tab" onclick="showChart('gains', this)">üíπ Daily Gains/Losses</button>
                <button class="tab" onclick="showChart('breakdown', this)">ü•ß Category Breakdown</button>
                <button class="tab" onclick="showChart('comparison', this)">üìä Category Comparison</button>
            </div>

            <!-- Charts -->
            <div class="chart-container" id="performanceChart">
                <div class="chart-title">Daily Performance Trends</div>
                <div class="chart-wrapper">
                    <canvas id="performanceCanvas"></canvas>
                </div>
            </div>

            <div class="chart-container" id="gainsChart" style="display: none;">
                <div class="chart-title">Daily Gains/Losses Analysis</div>
                <div class="chart-wrapper">
                    <canvas id="gainsCanvas"></canvas>
                </div>
            </div>

            <div class="grid-2" id="otherCharts" style="display: none;">
                <div class="chart-container">
                    <div class="chart-title">Total Sales Breakdown</div>
                    <div class="chart-wrapper">
                        <canvas id="pieCanvas"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Category Performance</div>
                    <div class="chart-wrapper">
                        <canvas id="barCanvas"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-container" id="comparisonChart" style="display: none;">
                <div class="chart-title">Category Performance Comparison</div>
                <div class="chart-wrapper">
                    <canvas id="comparisonCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let salesData = [];
        let charts = {};
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSy-gNhdVGwWtpwJIZ2358iDhM0RQlQoen-_wayM6Dc0rkp9mRx40uLo4ia2QD3Kr_QNn75xp8OJKEx/pub?gid=1227672918&single=true&output=csv';

        function parseNumber(str) {
            if (!str || str.trim() === '') return 0;
            return parseFloat(str.replace(/[",\s]/g, '')) || 0;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateStr) {
            try {
                const parts = dateStr.split('.');
                if (parts.length === 3) {
                    return `${parts[1]}/${parts[2]}`;
                }
                return dateStr;
            } catch (e) {
                return dateStr;
            }
        }

        async function loadData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const dashboard = document.getElementById('dashboard');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            dashboard.style.display = 'none';

            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const csvText = await response.text();
                const lines = csvText.trim().split('\n');
                
                if (lines.length < 2) throw new Error('Invalid data format');

                // Process data
                salesData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line || line.includes(',,,')) continue;

                    const cols = line.split(',');
                    if (cols.length < 8) continue;

                    const date = cols[0];
                    const ux = parseNumber(cols[1]);
                    const dx = parseNumber(cols[2]);
                    const vpower = parseNumber(cols[3]);
                    const total = parseNumber(cols[4]);

                    // Skip invalid entries
                    if (!date || total <= 0) continue;

                    salesData.push({
                        date: date,
                        displayDate: formatDate(date),
                        UX: ux,
                        DX: dx,
                        VPOWER: vpower,
                        TOTAL: total,
                        UX_GAIN: parseNumber(cols[5]),
                        DX_GAIN: parseNumber(cols[6]),
                        VP_GAIN: parseNumber(cols[7]),
                        TOTAL_GAIN: parseNumber(cols[8])
                    });
                }

                if (salesData.length === 0) {
                    throw new Error('No valid data found');
                }

                updateStats();
                createCharts();
                showChart('performance');
                
                loading.style.display = 'none';
                dashboard.style.display = 'block';

                // Update last updated time
                const now = new Date();
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${now.toLocaleString()}`;

            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = `Error loading data: ${err.message}`;
                console.error('Error:', err);
            }
        }

        function updateStats() {
            const totalUX = salesData.reduce((sum, d) => sum + d.UX, 0);
            const totalDX = salesData.reduce((sum, d) => sum + d.DX, 0);
            const totalVP = salesData.reduce((sum, d) => sum + d.VPOWER, 0);
            const totalGains = salesData.reduce((sum, d) => sum + d.TOTAL_GAIN, 0);
            const avgDaily = salesData.reduce((sum, d) => sum + d.TOTAL, 0) / salesData.length;
            
            const positiveGainDays = salesData.filter(d => d.TOTAL_GAIN > 0).length;
            const winRate = (positiveGainDays / salesData.length) * 100;

            const stats = [
                {
                    label: 'Total UX Sales',
                    value: formatCurrency(totalUX),
                    change: salesData.length > 1 ? salesData[salesData.length - 1].UX_GAIN : 0
                },
                {
                    label: 'Total DX Sales',
                    value: formatCurrency(totalDX),
                    change: salesData.length > 1 ? salesData[salesData.length - 1].DX_GAIN : 0
                },
                {
                    label: 'Total V-Power Sales',
                    value: formatCurrency(totalVP),
                    change: salesData.length > 1 ? salesData[salesData.length - 1].VP_GAIN : 0
                },
                {
                    label: 'Daily Average',
                    value: formatCurrency(avgDaily),
                    change: null
                },
                {
                    label: 'Total Gains/Losses',
                    value: formatCurrency(totalGains),
                    change: totalGains
                },
                {
                    label: 'Win Rate',
                    value: `${winRate.toFixed(1)}%`,
                    change: winRate > 50 ? 1 : -1
                }
            ];

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                    ${stat.change !== null ? `
                        <div class="stat-change ${stat.change > 0 ? 'positive' : 'negative'}">
                            ${stat.change > 0 ? '‚Üó' : '‚Üò'} ${stat.change > 0 ? '+' : ''}${typeof stat.change === 'number' && stat.change !== 1 && stat.change !== -1 ? formatCurrency(Math.abs(stat.change)) : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function createCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => chart?.destroy());
            charts = {};

            const colors = {
                UX: '#3b82f6',
                DX: '#10b981',
                VPOWER: '#f59e0b',
                TOTAL: '#8b5cf6'
            };

            // Performance Chart
            const performanceCtx = document.getElementById('performanceCanvas').getContext('2d');
            charts.performance = new Chart(performanceCtx, {
                type: 'line',
                data: {
                    labels: salesData.map(d => d.displayDate),
                    datasets: [
                        {
                            label: 'UX',
                            data: salesData.map(d => d.UX),
                            borderColor: colors.UX,
                            backgroundColor: colors.UX + '20',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'DX',
                            data: salesData.map(d => d.DX),
                            borderColor: colors.DX,
                            backgroundColor: colors.DX + '20',
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: 'V-Power',
                            data: salesData.map(d => d.VPOWER),
                            borderColor: colors.VPOWER,
                            backgroundColor: colors.VPOWER + '20',
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            // Gains Chart
            const gainsCtx = document.getElementById('gainsCanvas').getContext('2d');
            charts.gains = new Chart(gainsCtx, {
                type: 'bar',
                data: {
                    labels: salesData.map(d => d.displayDate),
                    datasets: [
                        {
                            label: 'Total Gain/Loss',
                            data: salesData.map(d => d.TOTAL_GAIN),
                            backgroundColor: salesData.map(d => d.TOTAL_GAIN > 0 ? '#10b981' : '#ef4444'),
                            borderColor: salesData.map(d => d.TOTAL_GAIN > 0 ? '#059669' : '#dc2626'),
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            // Pie Chart
            const totalUX = salesData.reduce((sum, d) => sum + d.UX, 0);
            const totalDX = salesData.reduce((sum, d) => sum + d.DX, 0);
            const totalVP = salesData.reduce((sum, d) => sum + d.VPOWER, 0);

            const pieCtx = document.getElementById('pieCanvas').getContext('2d');
            charts.pie = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['UX', 'DX', 'V-Power'],
                    datasets: [{
                        data: [totalUX, totalDX, totalVP],
                        backgroundColor: [colors.UX, colors.DX, colors.VPOWER],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Bar Chart
            const barCtx = document.getElementById('barCanvas').getContext('2d');
            charts.bar = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ['UX', 'DX', 'V-Power'],
                    datasets: [{
                        label: 'Total Sales',
                        data: [totalUX, totalDX, totalVP],
                        backgroundColor: [colors.UX, colors.DX, colors.VPOWER],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            // Comparison Chart
            const comparisonCtx = document.getElementById('comparisonCanvas').getContext('2d');
            charts.comparison = new Chart(comparisonCtx, {
                type: 'line',
                data: {
                    labels: salesData.map(d => d.displayDate),
                    datasets: [
                        {
                            label: 'Total Performance',
                            data: salesData.map(d => d.TOTAL),
                            borderColor: colors.TOTAL,
                            backgroundColor: colors.TOTAL + '20',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function showChart(chartType, element) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            if (element) {
                element.classList.add('active');
            } else {
                // If no element provided, find the tab by chart type
                const tabMap = {
                    'performance': 0,
                    'gains': 1,
                    'breakdown': 2,
                    'comparison': 3
                };
                const tabs = document.querySelectorAll('.tab');
                if (tabs[tabMap[chartType]]) {
                    tabs[tabMap[chartType]].classList.add('active');
                }
            }

            // Hide all charts
            document.getElementById('performanceChart').style.display = 'none';
            document.getElementById('gainsChart').style.display = 'none';
            document.getElementById('otherCharts').style.display = 'none';
            document.getElementById('comparisonChart').style.display = 'none';

            // Show selected chart
            switch(chartType) {
                case 'performance':
                    document.getElementById('performanceChart').style.display = 'block';
                    break;
                case 'gains':
                    document.getElementById('gainsChart').style.display = 'block';
                    break;
                case 'breakdown':
                    document.getElementById('otherCharts').style.display = 'block';
                    break;
                case 'comparison':
                    document.getElementById('comparisonChart').style.display = 'block';
                    break;
            }
        }

        // Auto-refresh every 30 minutes
        setInterval(loadData, 30 * 60 * 1000);

        // Initial load
        loadData();
    </script>
</body>
</html>
