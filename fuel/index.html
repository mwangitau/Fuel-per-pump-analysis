<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shell Mangu Fuel Pump Analysis</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* (keep your styles as you had; omitted here for brevity) */
    body{ /* your styles */ }
    .container{ /* your styles */ }
    /* etc. */
  </style>
</head>
<body>
  <div class="container">
    <h1>â›½ Shell Mangu Fuel Pump Analysis - Volume Sales (Litres)</h1>
    
    <div class="metrics-grid" id="metricsGrid"></div>
    
    <div class="filter-section">
      <select id="attendantFilter">
        <option value="all">All Attendants</option>
      </select>
      <select id="pumpFilter">
        <option value="all">All Pumps</option>
        <option value="PUMP 1">Pump 1</option>
        <option value="PUMP 2">Pump 2</option>
        <option value="PUMP3">Pump 3</option>
      </select>
      <button onclick="updateAnalysis()">Update Analysis</button>
    </div>
    
    <div class="chart-container">
      <canvas id="dailySalesChart"></canvas>
    </div>
    
    <div class="chart-container">
      <canvas id="attendantPerformanceChart"></canvas>
    </div>
    
    <div class="chart-container">
      <canvas id="pumpComparisonChart"></canvas>
    </div>
    
    <div class="analysis-section">
      <h3>ðŸ“Š Key Insights</h3>
      <ul class="insights-list" id="insightsList"></ul>
    </div>
    
    <div class="analysis-section">
      <h3>ðŸ“‹ Detailed Data</h3>
      <div style="overflow-x: auto;">
        <table class="data-table" id="dataTable"></table>
      </div>
    </div>
    
    <footer>
      <p>Â© 2025 Kiryan Energy Ltd â€” All Rights Reserved.</p>
      <p><strong>Confidential:</strong> These dashboards are for official use only and must not be copied, shared, or distributed without prior written permission from Kiryan Energy Ltd.</p>
    </footer>
  </div>

  <script>
    // CSV link
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTO3PNP1zG_QTHC6pY0lVTrchtBF36Tc1FKIuyGfBdexGVJNVj34reyTws-5vmGP8cst3YndAdNmB_P/pub?gid=1471167944&single=true&output=csv";
    
    // helper to parse CSV text to array-of-arrays
    function csvToRows(csv, delimiter = ',') {
      return csv.trim().split('\n').map(line => line.split(delimiter).map(cell => cell.trim()));
    }
    
    // format date like "2025.09.01" â†’ "2025-09-01"
    function formatDate(str) {
      if (!str) return str;
      const parts = str.split(".");
      if (parts.length < 3) return str;
      const year = parts[0];
      const month = parts[1].padStart(2, "0");
      const day = parts[2].padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    let processedData = [];
    let attendantsSet = new Set();
    let dailyTotals = {};
    let attendantTotals = {};
    let pumpTotals = {"PUMP 1": 0, "PUMP 2": 0, "PUMP3": 0};

    async function loadFuelData() {
      const resp = await fetch(csvUrl);
      const text = await resp.text();
      const rows = csvToRows(text);
      // assume first row is header; remove if needed
      rows.shift();

      processedData = []; 
      attendantsSet = new Set();
      dailyTotals = {};
      attendantTotals = {};
      pumpTotals = {"PUMP 1": 0, "PUMP 2": 0, "PUMP3": 0};

      rows.forEach(r => {
        // assuming your CSV rows match the hard-coded format; adjust indices if different
        const rawDate = r[0];
        const date = formatDate(rawDate);
        // extract fields safely
        const pump1Att = r[1]; const pump1Val = parseFloat(r[2]) || 0;
        const pump2Att = r[3]; const pump2Val = parseFloat(r[4]) || 0;
        const pump3Att = r[5]; const pump3Val = parseFloat(r[6]) || 0;
        
        const totalForDay = pump1Val + pump2Val + pump3Val;

        processedData.push({
          date,
          pump1: { attendant: pump1Att, value: pump1Val },
          pump2: { attendant: pump2Att, value: pump2Val },
          pump3: { attendant: pump3Att, value: pump3Val },
          total: totalForDay
        });

        attendantsSet.add(pump1Att);
        attendantsSet.add(pump2Att);
        attendantsSet.add(pump3Att);

        dailyTotals[date] = (dailyTotals[date] || 0) + totalForDay;

        // accumulate per attendant
        [ {att: pump1Att, val: pump1Val}, {att: pump2Att, val: pump2Val}, {att: pump3Att, val: pump3Val} ].forEach(item => {
          if (!attendantTotals[item.att]) attendantTotals[item.att] = 0;
          attendantTotals[item.att] += item.val;
        });

        pumpTotals["PUMP 1"] += pump1Val;
        pumpTotals["PUMP 2"] += pump2Val;
        pumpTotals["PUMP3"] += pump3Val;
      });

      populateFilters();
      updateAnalysis();  // draw charts/tables with loaded data
    }

    function populateFilters() {
      const af = document.getElementById('attendantFilter');
      // clear existing except "all"
      af.innerHTML = '<option value="all">All Attendants</option>';
      Array.from(attendantsSet).sort().forEach(att => {
        const opt = document.createElement('option');
        opt.value = att;
        opt.textContent = att;
        af.appendChild(opt);
      });
    }

    // reuse your existing updateAnalysis, createDailySalesChart, etc but they must read from processedData etc.

    function updateAnalysis() {
      // compute metrics, charts, table etc using processedData, dailyTotals, attendantTotals, pumpTotals
      updateMetrics();
      createDailySalesChart();
      createAttendantChart();
      createPumpChart();
      updateInsights();
      updateDataTable();
    }

    // (youâ€™ll need to adjust your existing functions to use the new processedData etc.)

    document.addEventListener('DOMContentLoaded', loadFuelData);

  </script>
</body>
</html>

